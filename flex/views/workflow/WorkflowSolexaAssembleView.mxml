<?xml version="1.0" encoding="utf-8"?>
<mx:VBox styleName="panelBox"  xmlns:mx="http://www.adobe.com/2006/mxml" 
	width="100%" height="100%"
	xmlns:util="views.util.*" 
	xmlns:renderers="views.renderers.*" verticalGap="0" paddingTop="0" paddingRight="4" paddingLeft="4" paddingBottom="0"
>
	<mx:HBox verticalAlign="middle" width="100%" >
		<mx:Image source="{parentApplication.iconSolexa}"/>
		<mx:Label id="titleLabel" styleName="titleLabel" 
				  text="" />
		<mx:HBox  horizontalAlign="center">
			<!--<mx:LinkButton id="instructions" icon="@Embed(source='../../assets/information.png')" label="Instructions" click="{showHideInstructions()}"/>
			<mx:TextArea styleName="instructionBox" visible="false" includeInLayout="false" id="instructionText" wordWrap="false" height="20" paddingLeft="4" paddingRight="4" width="600">
			<mx:htmlText><![CDATA[To assemble flow cell, drag ctrl or seq. req. onto flow cell.  To drag multiple, hold SHIFT or CTRL key while selecting.]]></mx:htmlText>
			</mx:TextArea>	-->
			<util:ContextHelp context1="assembleFlowCellHelp" context2="{parentDocument.coreFacility.@idCoreFacility}" showEdit="{parentApplication.isAdminState}"
							  labelPlacement="left" id="assembleFlowCellContextHelp" />
		</mx:HBox>
		<mx:Spacer width="100%"/>
		
		 
		<mx:LinkButton textDecoration="underline" label="Refresh"  icon="@Embed('../../assets/action_refresh.gif')" 
					   click="refresh();" toolTip="Refresh worklist"/>	
	</mx:HBox>
	
	<mx:HTTPService 
		id="getWorkList" 
		url="GetWorkItemList.gx"
		resultFormat="e4x"
		destination="getWorkList"
		showBusyCursor="true"
		result="onGetWorkList(event)"
		fault="parentApplication.onFailHttpRequest('Unable to get work list', event)"
		useProxy="false">
		<mx:request>
			<codeStepNext>{codeStepNext}</codeStepNext>
		</mx:request>
	</mx:HTTPService >
	<mx:HTTPService 
		id="saveWorkItem" 
		url="SaveWorkItemSolexaAssemble.gx"
		resultFormat="e4x"
		showBusyCursor="true"
		result="onSaveWorkItem(event)"
		fault="parentApplication.onFailHttpRequest('Unable to save work list', event)"
		method="POST"
		useProxy="false">
	</mx:HTTPService >    
	
	<mx:HTTPService 
		id="deleteWorkItem"   
		url="DeleteWorkItem.gx" 
		resultFormat="e4x"
		showBusyCursor="true"
		result="onDeleteWorkItem(event)"
		fault="parentApplication.onFailHttpRequest('Unable to delete work item', event)"
		method="POST"
		useProxy="false">
	</mx:HTTPService > 
	
	<mx:XMLListCollection id="masterWorkList"																														/>
	<mx:XMLListCollection id="pendingSequenceLanesWorkList"			source="{masterWorkList.source}" filterFunction="filterPendingSequenceLanesWorkList" 								/> <!-- Left Hand Side Work List -->
	<mx:XMLListCollection id="assembleFlowCellWorkList" 			source="{masterWorkList.source}" filterFunction="filterAssembleFlowCellWorkList"  sort="{sortRHSList}" /> <!-- Right Hand Side Work List -->
	<mx:XMLListCollection id="controlsList" 						source="{masterWorkList.source}" filterFunction="filterControlsList" 									/>
	<mx:XMLListCollection id="sequenceProtocolsList"			 									 filterFunction="filterSequenceProtocolsList"	 					 /> <!-- active protocols -->
	<mx:XMLListCollection id="flowCellChannelsCountList" />
	<mx:Sort id="sortRHSList" compareFunction="sortRHS" />
	<mx:ArrayCollection id="controlChannelsArray" />
	<!-- <mx:Binding source="flowCellChannelsCountList" destination="{channelChooserColumn.itemEditor.}" /> -->
	
	<mx:Script>
		<![CDATA[
			import hci.flex.controls.ComboBox;
			import hci.flex.controls.Label;
			import hci.flex.controls.TextInput;
			
			import mx.collections.ArrayCollection;
			import mx.collections.Sort;
			import mx.controls.Alert;
			import mx.events.CloseEvent;
			import mx.events.CollectionEvent;
			import mx.events.CollectionEventKind;
			import mx.rpc.events.ResultEvent;
			
			import views.renderers.ComboBox;
			
			
			[Bindable]
			private var controlsCount:int = 0;
			
			[Bindable]
			public var codeStepNext:String;
			
			[Bindable]
			private var codeSequencingPlatform:String;
			
			private var flowCellChannelsCount:int = 0
			private var isValid:Boolean = true;			
			private var warningMessage:String = "";
			private var hasError:Boolean = false;
			private var errorMessage:String = "";
		]]>
	</mx:Script>
	<!--							Initialize and Refresh Functions				-->
	<mx:Script>
		<![CDATA[
			
			// called by NavWorkflowView/onHiSeqWorklistChange
			public function init(maxFlowCells:int):void {
				flowCellChannelsCount = maxFlowCells;				
				if(codeStepNext == 'HSEQASSEM'){
					titleLabel.text = 'Illumina HiSeq Flow Cell Assembly';
					hboxGroupSide.visible = true;
					hboxGroupSide.includeInLayout = true;
					codeSequencingPlatform = "HISEQ";
				} else if (codeStepNext == 'MISEQASSEM') {
					titleLabel.text = 'Illumina MiSeq Flow Cell Assembly';
					hboxGroupSide.visible = false;
					hboxGroupSide.includeInLayout = false;
					codeSequencingPlatform = "MISEQ";
				}
				if(codeStepNext != null && codeStepNext != '') {
					refresh();
				}
			}
			private function initializeSequenceProtocolsList():void {
				sequenceProtocolsList.source = parentApplication.dictionaryManager.getEntriesExcludeBlank('hci.gnomex.model.NumberSequencingCyclesAllowed').(@isActive == 'Y');
			}			
			private function initializeFlowCellChannelsCountList():void {
				flowCellChannelsCountList = new XMLListCollection();
				flowCellChannelsCountList.addItem(new XML('<FlowCellChannelCount display=""  value=""  />'));
				for(var i:int = 1; i <= flowCellChannelsCount; i++) {
					flowCellChannelsCountList.addItem(new XML('<FlowCellChannelCount display="' + i + '" value="' + i + '" />'));
				}
				
			}
			private function initializeControlChannelsArray():void {
				for(var i:int = 0; i < flowCellChannelsCount; i++) {
					controlChannelsArray.addItemAt(false,i);
				}
			}
			private function initializeMasterWorkList():void {
				var source:XMLListCollection  = new XMLListCollection(getWorkList.lastResult.Request.MultiplexLane.WorkItem.copy());
				
				// add idRequestAndMultiplexGroup for grouping in pendingSequenceLanesGrid
				for each(var wi:XML in source) {
					wi.@idRequestAndMultiplexGroup = wi.@idRequest + "-" + wi.@multiplexGroupNumber;
					wi.@editable = "false";
					wi.@isControl = "false";
				}				
				// add controls to masterWorkList
				for each(var control:XML in parentApplication.dictionaryManager.getEntriesExcludeBlank('hci.gnomex.model.SequencingControl') ) {
					controlsCount++;
					control.@number = control.@display;	
					control.@editable = "true";
					control.@isControl = "true";
					source.addItem(control);
				}				
				masterWorkList.source = source.copy();

				//channelChooserColumn.itemEditor=views.renderers.GridColumnFillButton.create(views.renderers.ComboBox.create(flowCellChannelsCountList,'@display', '@value', '@flowCellChannelNumber', null, true).newInstance(), 'idRequestAndMultiplexGroup');
			}
			
			
			
			private function refresh():void {
				// reset user filters
				this.labCombo.selectedItem = null;
//				this.numberOfCyclesFilter.text = "";
//				this.seqRunTypeFilterCombo.selectedItem = null;
				this.lookupExperimentNumber.text = "";
				this.sequenceProtocolFilter.selectedItem = null;
				// reset flow cell info
				this.flowCellBarcode.text = ""; 
				this.flowCellRunNumber.text = ""; 
				this.flowCellCreateDate.selectedDate = null; 
				this.flowCellInstrument.selectedIndex = 0; 
				this.flowCellSide.selectedValue = null; 
				this.flowCellProtocol.selectedItem = null;
				
				initializeFlowCellChannelsCountList();
				initializeControlChannelsArray();
				initializeSequenceProtocolsList();
				getWorkList.send();
			}
			private function onGetWorkList(event:ResultEvent):void {
				if (event.result.name() == "WorkItemList") {					
					masterWorkList.addEventListener(CollectionEvent.COLLECTION_CHANGE, this.underlyingWorkItemDataChange);
					initializeMasterWorkList();						
				} else {
					Alert.show(event.result..ERROR.@message.toString(), "Error getting work list");
				}
			}
			private function refreshWorkList():void {			
				getWorkList.send();				
			}
			
		]]>
	</mx:Script>
	<!--						End Initilize and Refresh Functions					-->
	<!--							Filters											-->
	<mx:Script>
		<![CDATA[
			
			public function filterSequenceProtocolsList(item:Object):Boolean {
				return item.@codeRequestCategory == codeSequencingPlatform;
			}
			
			public function filterPendingSequenceLanesWorkList(item:Object):Boolean {
//				// if there are no user selected filters, include all <WorkItem>s
//				if ((this.labCombo.selectedItem == null || this.labCombo.selectedItem.@idLab == '') &&
//					//this.numberOfCyclesFilter.text == '' && 
//					this.lookupExperimentNumber.text == '' &&
//					//(this.seqRunTypeFilterCombo.selectedItem == null || 
//						//this.seqRunTypeFilterCombo.selectedItem.@idSeqRunType == '')) {
//					if(item.name() == 'WorkItem') {
//						return true;
//					} else {
//						return false;
//					}					
//				}
				// if the item is not a WorkItem don't show it (i.e. DictionaryEntry for Sequence Controls)
				if(item.name() != 'WorkItem') { return false; }
				
				// if no filters are selected return all WorkItems
				if( (this.labCombo.selectedItem == null || this.labCombo.selectedItem.@idLab == '') &&
				this.lookupExperimentNumber.text == '' &&
				(this.sequenceProtocolFilter.selectedItem == null || this.sequenceProtocolFilter.selectedItem.@idNumberSequencingCyclesAllowed == '')){
					return true;
				}				
				
				var matchesLab:Boolean				= true;
				var matchesExperimentNumber:Boolean = true;
				var matchesSequenceProtocol:Boolean = true;
				if (this.labCombo.selectedItem != null && this.labCombo.selectedItem.@idLab !='') {
					if(item.@idLab != this.labCombo.selectedItem.@idLab) {
						matchesLab = false;
					}
				}
				
				if (this.lookupExperimentNumber.text != '') {
					if(!item.@number.toString().match(new RegExp(this.lookupExperimentNumber.text + ".*", "i"))) {
						matchesExperimentNumber = false;
					}
				}
				if (this.sequenceProtocolFilter.selectedItem != null && this.sequenceProtocolFilter.selectedItem.@idNumberSequencingCyclesAllowed != '') {
					if(item.@idNumberSequencingCyclesAllowed != this.sequenceProtocolFilter.selectedItem.@idNumberSequencingCyclesAllowed) {
						matchesSequenceProtocol = false;
					}
				}
				
				// all for compounding of filters
				return matchesLab && matchesExperimentNumber && matchesSequenceProtocol;
				
				// for number of cycles, seqruntype and lab, include the item unless it fails one of the remaining user selected filters
//				var matchesCycles:Boolean = true;
//				var matchesSeqRunType:Boolean = true;
//				var matchesLab:Boolean = true;
//				if(numberOfCyclesFilter.text != '') {
//					if(item.@numberSequencingCycles != numberOfCyclesFilter.text) {
//						matchesCycles = false;
//					}
//				}
//				if (this.seqRunTypeFilterCombo.selectedItem != null && this.seqRunTypeFilterCombo.selectedItem.@idSeqRunType != '') {
//					if (item.@idSeqRunType != seqRunTypeFilterCombo.selectedItem.@idSeqRunType) {
//						matchesSeqRunType = false;
//					}
//				}
//				if (labCombo.selectedItem != null && labCombo.selectedItem.@idLab != '') {
//					if (item.@idLab != labCombo.selectedItem.@idLab) {
//						matchesLab = false;
//					}
//				}
//				return matchesCycles && matchesSeqRunType && matchesLab;
			}			
			public function filterAssembleFlowCellWorkList(item:Object):Boolean {
				if(item.hasOwnProperty("@flowCellChannelNumber") && item.@flowCellChannelNumber != '') {
					return true;
				} else {
					return false;
				}
			}
			public function filterControlsList(item:Object):Boolean {
				if(item.name() == "DictionaryEntry") {
					return true;
				} else {
					return false;
				}
			}
		]]>
	</mx:Script>
	<mx:Script>
		<![CDATA[
			

			
			
			private function underlyingWorkItemDataChange(event:CollectionEvent):void {
				if (event.kind == CollectionEventKind.RESET || 
					event.kind == CollectionEventKind.REFRESH || 
					["@isControl","@isDirty","@editable"].indexOf(event.items[0].property) > -1) {
					// ignore refresh and resets to work list
					return;
				} else if( (["@flowCellChannelNumber"].indexOf(event.items[0].property) > -1) && (event.items[0].source.@flowCellChannelNumber != '') ) {
					addingToFlowCell(event);

				} else if( (["@flowCellChannelNumber"].indexOf(event.items[0].property) > -1) && (event.items[0].source.@flowCellChannelNumber == '') ) {
					removingFromFlowCell(event);
				} else  {
					//dirty.setDirty();
				}
			}
			
			private function addingToFlowCell(event:CollectionEvent):void {
				
				// we are adding to the assembleFlowCellGrid
				if(flowCellProtocol.selectedItem == null) {
					for each(var protocol:XML in sequenceProtocolsList) {
						if(protocol.@idNumberSequencingCyclesAllowed == event.items[0].source.@idNumberSequencingCyclesAllowed) {
							flowCellProtocol.selectedItem = protocol;
							break;
						}
					}						
				}					

				callLater(addControlBoxes);
			}
			private function removingFromFlowCell(event:CollectionEvent):void {
				event.items[0].source.@editable = "false";
				event.items[0].source.@isControl = "false";
				callLater(addControlBoxes);
			}
			private function addControlBoxes():void {				
				var j:int = 0;
				for(var i:int = 0; i < controlChannelsArray.length; i++) {	
					var cc:Boolean = controlChannelsArray.getItemAt(i);					
					var isFirst:Boolean = true;
					var isControl:Boolean = true;
					for(j; j < assembleFlowCellWorkList.length; j++) {
						var sl:XML = assembleFlowCellWorkList.getItemAt(j) as XML;
						if(sl.@flowCellChannelNumber == i + 1) {
							if(isFirst) {
								sl.@editable = "true";
								isFirst = false;
							} else {
								sl.@editable = "false";
							}
							if(cc == true && isControl) {
								sl.@isControl = "true";
								isControl = false;
							} else {
								sl.@isControl = "false";
							}							
						} else {
							break;
						}
					}
				}
			}
	]]>
</mx:Script>
	<!--					Save Functions							-->
<mx:Script>
	<![CDATA[			
		import mx.controls.List;
			private function save():void {								
				warningMessage = "";
				isValid = true;
				hasError = false;
				if(flowCellProtocol.selectedItem == null) {
					isValid = false;
					warningMessage += "Please choose a sequencing protocol for the flow cell.\n\n";
					Alert.show(warningMessage, "Warning");
					return;
				}
				if (assembleFlowCellWorkList.length > 0) {
					validateNumberOfLanes();
//					validateProtocol();
					validateProtocolAndLanes();
					validateIndexTags();
					//validateSeqRunType();
					//validateNumberSequencingCycles();
				}
				if (isValid && !hasError) {
					saveWorkItems();				    
				} else if (!hasError) {
					promptForWarning();
				} else {
					Alert.show(errorMessage, "Error");
					return;
				}
			}
			private function validateNumberOfLanes():void {
				var tmp:ArrayCollection = new ArrayCollection();
				for(var i:int = 1; i < flowCellChannelsCount; i++) {
					tmp.addItem(i + "");
				}
				for each(var tmpx:XML in assembleFlowCellWorkList) {
					if(tmpx.hasOwnProperty("@flowCellChannelNumber") && tmp.contains(tmpx.@flowCellChannelNumber.toString())) {
						tmp.removeItemAt(tmp.getItemIndex(tmpx.@flowCellChannelNumber.toString()));
						tmp.refresh();
					}
				}
				if (tmp.length > 0) {
					if(flowCellChannelsCount > 1) {
						warningMessage = "Not all " + flowCellChannelsCount + " lanes are populated.\n\n";
					} else {
						warningMessage = "The channel is not populated.\n\n";
					}
					isValid = false;
				}					
			}			
			//Warn if not all channels are of the same protocol type
			private function validateProtocol():void {
				var firstProtocol:String = '';
				// get the protocol of the first WorkItem in the list
				for each(var wi:XML in assembleFlowCellWorkList) {
					if(wi.name() == "DictionaryEntry") {
						continue;
					} else {
						firstProtocol = wi.@idNumberSequencingCyclesAllowed;
						break;
					}
				}
//				for each(wi in assembleFlowCellWorkList) {
//					if(wi.name() == "DictionaryEntry") {
//						continue;
//					} else if(wi.@idNumberSequencingCyclesAllowed == firstProtocol) {
//						continue;
//					} else {
//						warningMessage += "The samples do not all have the same protocol.\n\n";
//						isValid = false;
//						break;
//					}
//				}
			}
			// Warn if not all lanes have same protocol as flow cell
			private function validateProtocolAndLanes():void {
				for each(var wi:XML in assembleFlowCellWorkList) {
					if(wi.name() == "DictionaryEntry") {
						continue;
					}
					if (wi.@idNumberSequencingCyclesAllowed == '' || wi.@idNumberSequencingCyclesAllowed == null) {
						errorMessage = "One or more samples have no sequencing protocol.  Please correct sequence lanes before continuing.";
						hasError = true;
					}
					if(wi.@idNumberSequencingCyclesAllowed != flowCellProtocol.selectedItem.@idNumberSequencingCyclesAllowed) {
						warningMessage += "One or more samples have different protocols from the flow cell.\n\n";
						isValid = false;
						break;
					}
				}
			}
			private function validateIndexTags():void {
				for each(var channelNumber:XML in flowCellChannelsCountList) {

					var i:String = channelNumber.@value;
					if(!areBarcodeSequenceTagsUnique(i)) {
						warningMessage += "Two or more samples in channel " + i + " do not differ by at least 3 base pairs.\n\n";
						isValid = false;
					}
				}
			}
			private function areBarcodeSequenceTagsUnique(flowCellChannelNumber:String):Boolean {

				var barcodes:ArrayCollection = new ArrayCollection();
				
				for each(var wi:Object in assembleFlowCellWorkList) {
					if (wi.@flowCellChannelNumber == flowCellChannelNumber) {
						var tag:Object = wi.@barcodeSequence + wi.@barcodeSequenceB;
						//barcodeSequenceMap[tag] = tag;
						if(tag != null && tag != ""){
							barcodes.addItem(tag);
						}
						//workItemCount++;
					}
				}
				
				for(var i:int = 0; i < barcodes.length; i++){
					var sequenceOne:Array = String(barcodes.getItemAt(i)).split("");
					for(var j:int = i+1; j < barcodes.length; j++){
						var sequenceTwo:Array = String(barcodes.getItemAt(j)).split("");
						if(!atLeastThreeUnique(sequenceOne, sequenceTwo)){
							return false;
						}
					}
				}
				

			
				return true;
			}
		
			private function atLeastThreeUnique(sequenceOne:Array, sequenceTwo:Array):Boolean{
				var uniqueBaseCount:int = 0;
				for(var i:int = 0; i < sequenceOne.length; i++){
					if(sequenceOne[i] != sequenceTwo[i]){
						uniqueBaseCount++;
					}
				}
				
				if(uniqueBaseCount >= 3){
					return true;
				} else{
					return false;
				}
			}
			
			private function saveWorkItems():void {
				
				var params:Object = new Object();
				params.flowCellBarcode = this.flowCellBarcode.text;
				params.flowCellDate = this.flowCellCreateDate.text
				params.workItemXMLString = assembleFlowCellWorkList.toXMLString();
				if(codeStepNext == 'SEQASSEM') {
					params.codeStepNext = 'SEQPIPE';
				} else if (codeStepNext == 'HSEQASSEM') {
					params.codeStepNext = 'HSEQFINFC';
				} else if (codeStepNext == 'MISEQASSEM') {
					params.codeStepNext = 'MISEQFINFC';
				}
				params.runNumber = this.flowCellRunNumber.text;
				params.idNumberSequencingCyclesAllowed = this.flowCellProtocol.selectedItem.@idNumberSequencingCyclesAllowed
				params.side = this.flowCellSide.selectedValue;
//				params.idCoreFacility = parentDocument.getSpecifiedIdCoreFacility();
				params.numberSequencingCyclesActual = this.flowCellProtocol.selectedItem.@numberSequencingCyclesDisplay;
				params.idSeqRunType = this.flowCellProtocol.selectedItem.@idSeqRunType;
				params.idInstrument = this.flowCellInstrument.selectedItem.@value;
			
				saveWorkItem.send(params);
			}	
			
			private function promptForWarning():void {
				if (warningMessage != "") {
					warningMessage += "Continue saving?";
					Alert.show(warningMessage, "Warning", (Alert.YES | Alert.NO), null, onPromptForWarning);
				}
			}
			private function onPromptForWarning(event:CloseEvent):void {
				if (event.detail == Alert.YES) {
					saveWorkItems();
				}
			}
			private function onSaveWorkItem(event:ResultEvent):void {
				if (saveWorkItem.lastResult.name() == "WorkItemList" || saveWorkItem.lastResult.name() == "SUCCESS" ) {
					if (saveWorkItem.lastResult.hasOwnProperty("@flowCellNumber") && saveWorkItem.lastResult.@flowCellNumber != "") {
						Alert.show("Flow Cell " + saveWorkItem.lastResult.@flowCellNumber + " has been created.");    			
					}
					refresh();
					
				} else {
					Alert.show(saveWorkItem.lastResult..ACTMESSAGE.@TEXT);
				}        	
			}
		]]>
	</mx:Script>
	<!--								END Save Functions								-->
	<!--								Grid Labeling Functions							-->
	<mx:Script>
		<![CDATA[
	
			//
			// Need to use these label functions instead of LabelDictionary item renderer because drag image is blank otherwise.
			//
			private function lookupSeqRunType(item:Object, col:Object):String {
				if (item != null  && item.hasOwnProperty("@idSeqRunType")) {
					var d:Object = parentApplication.dictionaryManager.getEntry('hci.gnomex.model.SeqRunType', item.@idSeqRunType);
					if (d != null) {
						return d.@display;
					} else {
						return "";
					}
				} else {
					return "";
				}
			}		
			private function lookupNumberSequencingCycles(item:Object, col:Object):String {
				if (item != null  && item.hasOwnProperty("@idNumberSequencingCycles")) {
					var d:Object = parentApplication.dictionaryManager.getEntry('hci.gnomex.model.NumberSequencingCycles', item.@idNumberSequencingCycles);
					if (d != null) {
						return d.@display; 
					} else {
						return "";
					}
				} else {
					return "";
				}
			}		
			private function lookupOligoBarcode(item:Object, col:Object):String {
				if (item != null && item.hasOwnProperty("@idOligoBarcode")) {
					if (item.@idOligoBarcode != '') {
						return parentApplication.dictionaryManager.getEntryDisplay("hci.gnomex.model.OligoBarcode", item.@idOligoBarcode);    		
					} else {
						return item.@barcodeSequence;
					}
				} else {
					return "";
				}
				
			}			
			private function lookupOligoBarcodeB(item:Object, col:Object):String {
				if (item != null && item.hasOwnProperty("@idOligoBarcodeB")) {
					if (item.@idOligoBarcodeB != '') {
						return parentApplication.dictionaryManager.getEntryDisplay("hci.gnomex.model.OligoBarcode", item.@idOligoBarcodeB);    		
					} else {
						return item.@barcodeSequenceB;
					}
				} else {
					return "";
				}
				
			}
			private function lookupNumberSequencingCyclesAllowed(item:Object, col:Object):String {			
				if (item != null  && item.hasOwnProperty("@idNumberSequencingCyclesAllowed")) {
					var d:Object = parentApplication.dictionaryManager.getEntry('hci.gnomex.model.NumberSequencingCyclesAllowed', item.@idNumberSequencingCyclesAllowed);
					if (d != null) {
						return d.@name; 
					} else {
						return "";
					}
				} else {
					return "";
				}
			}
			
			private function promptToDelete():void{
				Alert.show("You are about to delete " + this.pendingSequenceLanesGrid.selectedItems.length + " sequence lanes from the workflow.  Continue?", "Warning", (Alert.YES | Alert.NO), this, onPromptToDelete);
			}
			
			private function onPromptToDelete(event:CloseEvent):void {	
				if(event.detail==Alert.YES){
					var params:Object = new Object();
					var workItemIds:String = "";
					for(var i:int; i < this.pendingSequenceLanesGrid.selectedItems.length; i++){
						workItemIds += this.pendingSequenceLanesGrid.selectedItems[i].@idWorkItem + ",";
					}
					
					params.workItemIds = workItemIds.substring(0, workItemIds.lastIndexOf(","));
					deleteWorkItem.send(params);
				} else{
					return;
				}
			}
			
			private function onDeleteWorkItem(event:ResultEvent):void{
				if(deleteWorkItem.lastResult.name() == "SUCCESS"){
					Alert.show("Work item(s) successfully deleted.");
					getWorkList.send();
				} else{
					Alert.show(deleteWorkItem.lastResult..ACTMESSAGE.@TEXT);
				}
			}
			
		]]>
	</mx:Script>
	<!--							END Grid Labeling Functions						-->
	<mx:Script>
		<![CDATA[			
			import mx.events.ListEvent;

			
//			private function showHideInstructions():void {
//				if (instructionText.visible) {
//					instructionText.visible = false;
//					instructionText.includeInLayout = false;
//					instructions.label = "Instructions";
//				} else {
//					instructionText.visible = true;
//					instructionText.includeInLayout = true;
//					instructions.label = "Hide instructions";
//				}
//			}
			public function updateIsControl(event:Event):void {
				if(event.currentTarget.parentDocument.data.hasOwnProperty("@isControl") && event.currentTarget.parentDocument.data.@isControl == "true") {
					event.currentTarget.parentDocument.data.@isControl = "false";
					controlChannelsArray.setItemAt(false, (int(event.currentTarget.parentDocument.data.@flowCellChannelNumber) - 1));
				} else {
					event.currentTarget.parentDocument.data.@isControl = "true";
					controlChannelsArray.setItemAt(true,(int(event.currentTarget.parentDocument.data.@flowCellChannelNumber) - 1));
				}				
			}
			
			public function sortRHS(a:Object, b:Object, fields:Array = null ):int {
				var result:int = 0;
				var i:int = 0;
				var propList:Array = fields ? fields : ['@flowCellChannelNumber','@number'];
				var len:int = propList.length;
				var propName:String;
				while (result == 0 && (i < len)) {
					propName = propList[i];
					result = compareValues(a[propName], b[propName]);					
					i++;
				}
				return result;
//				// there was a tie, but if one is editable it needs to go UP
//				if(result == 0 && (a.hasOwnProperty('@editable') || b.hasOwnProperty('@editable'))){
//					if(a.@editable == 'true') {
//						return -1;
//					} else {
//						return 1;
//					}
//				}else {
//					return result;					
//				}
				
			}
			public function compareValues(a:Object, b:Object):int {
				if(a == null && b == null)
					return 0;
				if(a == null)
					return 1;
				if(b == null)
					return -1;
				if (a < b)
					return -1;
				if (a > b)
					return 1;
				return 0;
			}
			public function flowCellProtocolChangeHandler(event:ListEvent):void {
				//Alert.show("Changing the protocol for the flow cell will change the protocol for all samples it contains.", "Warning");
			}
			
			private function showAppUserName(row:Object):String{
				return row.@appUserName;
			}
			
		]]>
	</mx:Script>
	
	<mx:HDividedBox width="100%" height="100%">
		<!--																______________________________LHS START______________________________ 															-->
		<mx:VBox width="50%" height="100%">
			<mx:VBox width="100%" height="90">
				<mx:HBox height="100%" width="100%">
					<mx:VBox height="100%" width="100%">
						<mx:HBox width="100%">
							<mx:Label text="Pending Sequence Lanes" fontWeight="normal" styleName="formLabel" fontSize="12"/>
							<mx:Spacer width="100%"/>
							<mx:Label text="{'(' + pendingSequenceLanesWorkList.length + ' experiments)'}" fontWeight="normal" fontSize="11" fontStyle="italic"/>
						</mx:HBox>
						<mx:HBox paddingTop="0" width="100%" verticalAlign="middle" paddingBottom="1" horizontalGap="8">
							<mx:Label text="Protocol" styleName="labelSmall" width="69"/>
							<renderers:FilterComboBox dataProvider="{sequenceProtocolsList}" labelField="@name" fontSize="11"
													  prompt=" " width="310" close="{pendingSequenceLanesWorkList.refresh();}"
													  id="sequenceProtocolFilter">								
							</renderers:FilterComboBox>
<!--						<mx:HBox verticalAlign="middle"  horizontalGap="0">
								<mx:Label text="# Cycles" styleName="labelSmall" width="70"/>
								<mx:TextInput width="60" id="numberOfCyclesFilter" change="{lookupExperimentNumber.text='';pendingSequenceLanesWorkList.refresh()}" enter="{lookupExperimentNumber.text='';pendingSequenceLanesWorkList.refresh();}"  fontSize="10"/>
							</mx:HBox>
							<mx:HBox horizontalGap="1" borderStyle="none" cornerRadius="10" borderColor="#466D88" styleName="labelSmall">
								<renderers:FilterComboBox dataProvider="{parentApplication.dictionaryManager.xml.Dictionary.(@className == 'hci.gnomex.model.SeqRunType').DictionaryEntry.(@isActive == 'Y' &amp;&amp; @display != '')}" 
														  labelField="@display" fontSize="11"
														  prompt="Select a Sequence Run Type..." close="{lookupExperimentNumber.text='';pendingSequenceLanesWorkList.refresh();}" 
														  width="200"
														  id="seqRunTypeFilterCombo" >
								</renderers:FilterComboBox>
							</mx:HBox>-->
						</mx:HBox>
						<mx:HBox width="100%"  horizontalGap="8" paddingBottom="2" paddingTop="2">
							<!--<mx:HBox verticalAlign="middle"   horizontalGap="0">
								
							</mx:HBox>-->
							<mx:Label text="Experiment #" styleName="labelSmall" width="70"/>
							<mx:TextInput width="60" id="lookupExperimentNumber" change="{pendingSequenceLanesWorkList.refresh()}" enter="{pendingSequenceLanesWorkList.refresh()}"  fontSize="10"/>
							<mx:Label text="Lab" styleName="labelSmall" width="30"/>
							<renderers:FilterComboBox dataProvider="{parentApplication.submitRequestLabList}" 
													  labelField="@name" fontSize="11"
													  prompt=" " close="{pendingSequenceLanesWorkList.refresh();}" 
													  width="200"
													  id="labCombo" >
							</renderers:FilterComboBox>
						</mx:HBox>
					</mx:VBox>
					<mx:Spacer width="90%"/>
					<mx:VBox height="100%" width="100%">
						<mx:AdvancedDataGrid id="controlsGrid" width="145" height="90"
											 fontSize="10" resizableColumns="false" sortableColumns="false"
											 visible="{controlsCount == 0 ? false : true}"
											 dataProvider="{controlsList}"
											 >
							<mx:columns>
								<mx:AdvancedDataGridColumn  dataField="@number" width="75">
									<mx:headerRenderer>
										<mx:Component>
											<mx:VBox width="75" height="20" verticalGap="0" horizontalScrollPolicy="off"  horizontalAlign="center" verticalAlign="middle" maxWidth="150" >
												<mx:Label width="75" text="Control" />										
											</mx:VBox>
										</mx:Component>
									</mx:headerRenderer>
								</mx:AdvancedDataGridColumn>
								<mx:AdvancedDataGridColumn width="60">	
									<mx:headerRenderer>
										<mx:Component>
											<mx:VBox width="55" verticalGap="0"    horizontalScrollPolicy="off"  horizontalAlign="center" verticalAlign="middle" height="20"  maxWidth="60">
												<mx:Label width="55" text="Lane" />
											</mx:VBox>
										</mx:Component>
									</mx:headerRenderer>
									<mx:itemRenderer>
										<mx:Component>
											<mx:VBox width="55"  verticalGap="0"   horizontalScrollPolicy="off"  horizontalAlign="center" verticalAlign="middle"  maxWidth="60">								
												<mx:ComboBox width="55" id="flowCellLaneChooser" labelField="@display"
															 dataProvider="{outerDocument.flowCellChannelsCountList.source}"
															 change = " data.@flowCellChannelNumber = flowCellLaneChooser.selectedLabel "
															 selectedIndex="{parentDocument.getchannelNumber(data.@flowCellChannelNumber)}"								  />
											</mx:VBox>
										</mx:Component>
									</mx:itemRenderer>
								</mx:AdvancedDataGridColumn>
							</mx:columns>				
						</mx:AdvancedDataGrid>					
					</mx:VBox>
					<mx:Spacer width="90%"/>
				</mx:HBox>
			</mx:VBox>
			<mx:VBox width="100%" height="90%">
				<util:AdvancedDataGridGroupedRowColorsIdRequestAndMultiplexGroup
					id="pendingSequenceLanesGrid" width="100%" height="100%" 
					sortableColumns="false" 				
					fontSize="10"
					resizableColumns="true"
					dataProvider="{pendingSequenceLanesWorkList}" dataTipField="@appUserName"
					allowMultipleSelection="true"
					editable="true">
					<util:columns>
						<mx:AdvancedDataGridColumn id="channelChooserColumn" width="75"
												   dataField="@flowCellChannelNumber" editable="true"
												   rendererIsEditor="false" showDataTips="true"												    
												   editorDataField="value" >
							<mx:itemEditor>
								<mx:Component id ="channelChooserColumnItemEditor">
									<renderers:GridColumnFillButton fillColumnKey="idRequestAndMultiplexGroup">
										<renderers:edtComponent>
											<renderers:ComboBox id="channelChooserComboBox" dataProvider="{outerDocument.flowCellChannelsCountList}" 
																labelField="@display" valueField="@value" dataField="@flowCellChannelNumber" />	
										</renderers:edtComponent>										
									</renderers:GridColumnFillButton>
								</mx:Component>
							</mx:itemEditor> 
							<mx:headerRenderer>
								<mx:Component>
									<mx:VBox width="100%" verticalGap="0"   horizontalScrollPolicy="off"  horizontalAlign="center" verticalAlign="middle">
										<mx:Label text="Select Lane #" styleName="blueHeaderFlowCellAssembly" />
									</mx:VBox>
								</mx:Component>
							</mx:headerRenderer>
						</mx:AdvancedDataGridColumn>
						<mx:AdvancedDataGridColumn dataField="@number" showDataTips="true" editable="false" width="75" >
							<mx:headerRenderer>
								<mx:Component>
									<mx:VBox width="100%" verticalGap="0"   horizontalScrollPolicy="off"  horizontalAlign="center" verticalAlign="middle">
										<mx:Label text="Experiment"/>
									</mx:VBox>
								</mx:Component>
							</mx:headerRenderer>
						</mx:AdvancedDataGridColumn>
						<mx:AdvancedDataGridColumn dataField="@idOligoBarcode" showDataTips="true" labelFunction="lookupOligoBarcode" width="120" editable="false">
							<mx:headerRenderer>
								<mx:Component>
									<mx:VBox width="100%" verticalGap="0"   horizontalScrollPolicy="off"  horizontalAlign="center" verticalAlign="middle">
										<mx:Label text="Index Tag A"/>										
									</mx:VBox>
								</mx:Component>
							</mx:headerRenderer>
						</mx:AdvancedDataGridColumn>
						<mx:AdvancedDataGridColumn dataField="@idOligoBarcodeB" showDataTips="true" labelFunction="lookupOligoBarcodeB" width="120" editable="false">
							<mx:headerRenderer>
								<mx:Component>
									<mx:VBox width="100%" verticalGap="0"   horizontalScrollPolicy="off"  horizontalAlign="center" verticalAlign="middle">
										<mx:Label text="Index Tag B"/>
									</mx:VBox>
								</mx:Component>
							</mx:headerRenderer>
						</mx:AdvancedDataGridColumn>
						<mx:AdvancedDataGridColumn id="protocolChooserColumn" width="295"	
												   dataField="@idNumberSequencingCyclesAllowed" editable="false"
												   rendererIsEditor="false"
												   itemRenderer="{views.renderers.DropdownLabel.create(sequenceProtocolsList.source, '@display', '@value', '@idNumberSequencingCyclesAllowed', '@appUserName', true, true)}"
												   itemEditor="{views.renderers.GridColumnFillButton.create(views.renderers.ComboBox.create(sequenceProtocolsList.source,'@display', '@value', '@idNumberSequencingCyclesAllowed', null, true).newInstance(), 'idRequestAndMultiplexGroup')}" 
												   editorDataField="value" showDataTips="true">
							<mx:headerRenderer>
								<mx:Component>
									<mx:VBox width="100%" verticalGap="0"   horizontalScrollPolicy="off"  horizontalAlign="center" verticalAlign="middle">
										<mx:Label text="Sequencing Protocol"/>
									</mx:VBox>
								</mx:Component>
							</mx:headerRenderer>
						</mx:AdvancedDataGridColumn>							
					</util:columns>		
				</util:AdvancedDataGridGroupedRowColorsIdRequestAndMultiplexGroup>
			</mx:VBox>
<!--			<mx:HBox width="100%" height="8%" verticalGap="0" borderStyle="solid">				
				
				<mx:DataGrid dataProvider="{pendingSequenceLanesGrid.selectedItems}" fontSize="8">
					<mx:columns>							
						<mx:DataGridColumn dataField="@number" headerText="Num" />
						<mx:DataGridColumn dataField="@idRequest" headerText="Req"/>
						<mx:DataGridColumn dataField="@multiplexGroupNumber" headerText="Mplex" />
						<mx:DataGridColumn dataField="@idRequestAndMultiplexGroup" headerText="idReq&amp;Mplex"/>
						<mx:DataGridColumn dataField="@flowCellChannelNumber" headerText="Chnl"/>
						<mx:DataGridColumn dataField="@codeRequestCategory" headerText="ReqCat" />
						<mx:DataGridColumn dataField="@idSeqRunType" headerText="SeqType" labelFunction="lookupSeqRunType" />
						<mx:DataGridColumn dataField="@idNumberSequenceCycles" headerText="NumCycls" labelFunction="lookupNumberSequencingCycles"/>						
					</mx:columns>
				</mx:DataGrid>
			</mx:HBox> -->
		</mx:VBox>
		<!-- 																______________________________LHS END______________________________ 															-->
		<!-- 																______________________________RHS START______________________________ 															-->
		<mx:VBox width="50%" height="100%">
			<mx:VBox width="100%" height="90">

				<mx:Label text="Flow Cell to Assemble" styleName="formLabel" fontSize="12"/>
				<mx:HBox width="100%" verticalAlign="middle">
					<mx:Label text="{this.codeSequencingPlatform == 'MISEQ' ? 'Reagent Cartridge Barcode' : 'Flowcell Barcode'}" styleName="formLabel" 
							  width="{this.codeSequencingPlatform == 'MISEQ' ? 140 : 90}"/>
					<mx:TextInput id="flowCellBarcode" width="130" fontSize="10"/>
					<mx:Label text="Run #" styleName="formLabel"/>
					<mx:TextInput id="flowCellRunNumber" width="40" restrict="0-9" fontSize="10"/>
					<mx:Label text="Create Date" styleName="formLabel" width="83" textAlign="right"/>
					<mx:DateField id="flowCellCreateDate" showToday="true" fontSize="10"/>
				</mx:HBox>
				<mx:HBox width="100%" verticalAlign="middle">
					<mx:Label text="Instrument" styleName="formLabel" width="60"/>
					<mx:ComboBox width="130" id="flowCellInstrument"
								 labelField="@display"
								 dataProvider="{parentApplication.dictionaryManager.xml.Dictionary.(@className == 'hci.gnomex.model.Instrument').DictionaryEntry.(@isActive=='Y')}" fontSize="11">
					</mx:ComboBox>
					<mx:HBox id="hboxGroupSide" paddingTop="0" paddingBottom="0" borderStyle="none" cornerRadius="10" borderColor="#466D88" paddingLeft="0" paddingRight="0">
						<mx:RadioButtonGroup id="flowCellSide"/>
						<mx:RadioButton groupName="flowCellSide" label="Side A" styleName="labelSmall" id="radioSideA" paddingBottom="0" paddingLeft="4" paddingRight="0" paddingTop="0" textAlign="left" horizontalGap="0" verticalGap="0" value="A">
						</mx:RadioButton>
						<mx:RadioButton groupName="flowCellSide" label="Side B" styleName="labelSmall" id="radioSideB" paddingLeft="0" paddingBottom="0" paddingRight="4" paddingTop="0" horizontalGap="0" verticalGap="0" value="B">
						</mx:RadioButton>
					</mx:HBox>
					<mx:HBox horizontalGap="10" verticalAlign="middle">
						<mx:Label text="Protocol" styleName="formLabel" width="45"/>
						<renderers:FilterComboBox id="flowCellProtocol" labelField="@name" width="300" prompt=" "
												  dataProvider="{sequenceProtocolsList}" change="flowCellProtocolChangeHandler(event)">							
						</renderers:FilterComboBox>
					<!--<mx:ComboBox width="300" id="flowCellProtocol" labelField="@name" rowCount="{sequenceProtocolsList.length}" dataProvider="{sequenceProtocolsList}" change="flowCellProtocolChangeHandler(event)"/>-->
					</mx:HBox>					
				</mx:HBox>							
			</mx:VBox>
		<mx:VBox width="100%" height="90%">
			<util:AdvancedDataGridGroupedRowColorsFlowCellChannelNumber  id="assembleFlowCellGrid" width="100%" height="100%" displayItemsExpanded="true"
								 sortableColumns="false" 
								 dataProvider="{assembleFlowCellWorkList}"
								 fontSize="10" resizableColumns="true"
								 >
				<util:columns>
					<mx:AdvancedDataGridColumn dataField="@number" editable="false" headerText="Experiment" width="90" >
						<mx:headerRenderer>
							<mx:Component>
								<mx:VBox width="100%" verticalGap="0"   horizontalScrollPolicy="off"  horizontalAlign="center" verticalAlign="middle">
									<mx:Label text="Experiment"/>
								</mx:VBox>
							</mx:Component>
						</mx:headerRenderer>
					</mx:AdvancedDataGridColumn>
					<mx:AdvancedDataGridColumn width="60">
						<mx:headerRenderer>
							<mx:Component>
								<mx:VBox width="100%" verticalGap="0"   horizontalScrollPolicy="off"  horizontalAlign="center" verticalAlign="middle">
									<mx:Label text="Control"/>
								</mx:VBox>
							</mx:Component>
						</mx:headerRenderer>
						<mx:itemRenderer>
							<mx:Component>
								<mx:Box verticalGap="0"   horizontalScrollPolicy="off"  horizontalAlign="center" verticalAlign="middle">
									<mx:CheckBox change="outerDocument.updateIsControl(event);" visible="{data.@editable == 'true'}" includeInLayout="{data.@editable == 'true'}" selected="{data.@isControl == 'true'}" />
								</mx:Box>
							</mx:Component>
						</mx:itemRenderer>
					</mx:AdvancedDataGridColumn>
					<mx:AdvancedDataGridColumn dataField="@flowCellChannelNumber" width="50">			
						<mx:headerRenderer>
							<mx:Component>
								<mx:VBox width="100%" verticalGap="0"   horizontalScrollPolicy="off"  horizontalAlign="center" verticalAlign="middle">
									<mx:Label text="Lane"/>
								</mx:VBox>
							</mx:Component>
						</mx:headerRenderer>	
					</mx:AdvancedDataGridColumn>
					<mx:AdvancedDataGridColumn dataField="@idOligoBarcode" labelFunction="lookupOligoBarcode" width="120" >
						<mx:headerRenderer>
							<mx:Component>
								<mx:VBox width="100%" verticalGap="0"   horizontalScrollPolicy="off"  horizontalAlign="center" verticalAlign="middle">
									<mx:Label text="Index Tag A"/>
								</mx:VBox>
							</mx:Component>
						</mx:headerRenderer>
					</mx:AdvancedDataGridColumn>
					<mx:AdvancedDataGridColumn dataField="@idOligoBarcodeB" labelFunction="lookupOligoBarcodeB" width="120" >
						<mx:headerRenderer>
							<mx:Component>
								<mx:VBox width="100%" verticalGap="0"   horizontalScrollPolicy="off"  horizontalAlign="center" verticalAlign="middle">
									<mx:Label text="Index Tag B"/>
								</mx:VBox>
							</mx:Component>
						</mx:headerRenderer>
					</mx:AdvancedDataGridColumn>
					<mx:AdvancedDataGridColumn width="300" dataField="@idNumberSequencingCyclesAllowed" labelFunction="lookupNumberSequencingCyclesAllowed"   >
						<mx:headerRenderer>
							<mx:Component>
								<mx:VBox width="100%" verticalGap="0"   horizontalScrollPolicy="off"  horizontalAlign="center" verticalAlign="middle">
									<mx:Label text="Sequencing Protocol"/>
								</mx:VBox>
							</mx:Component>
						</mx:headerRenderer>
					</mx:AdvancedDataGridColumn>
				</util:columns>		
			</util:AdvancedDataGridGroupedRowColorsFlowCellChannelNumber>				
			</mx:VBox>
			
		</mx:VBox>
		<!-- 																______________________________RHS END_______________________________________ 															-->
	</mx:HDividedBox>
	<mx:ControlBar horizontalAlign="right" width="100%">
		<mx:HBox width="100%" horizontalAlign="left">
			<mx:LinkButton label="Delete" id="deleteButton" icon="@Embed('../../assets/delete.png')" 
						   click="promptToDelete()"
						   letterSpacing=".3" horizontalGap="0" toolTip="Delete selected sequence lanes"  enabled="{this.pendingSequenceLanesGrid.selectedItems.length > 0}" textDecoration="underline" 
						   disabledIcon="@Embed(source='../../assets/delete_disable.png')">
			</mx:LinkButton>
		</mx:HBox>
		<util:DirtyNote id="dirty"/>
		<mx:Button label="Save" id="saveButton" icon="@Embed(source='../../assets/save.png')" disabledIcon="@Embed(source='../../assets/save_disable.png')" click="save()"/>
	</mx:ControlBar>	
</mx:VBox>
