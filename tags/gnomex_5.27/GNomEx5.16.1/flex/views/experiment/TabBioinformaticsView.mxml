<?xml version="1.0" encoding="utf-8"?>
<mx:Canvas label="Bioinformatics" xmlns:mx="http://www.adobe.com/2006/mxml" width="100%" height="100%" xmlns:util="views.util.*" show="{init();}">
	<mx:states>
		<mx:State name="EditState">
			<mx:RemoveChild target="{genomeBuildBox}" />
		</mx:State>
	</mx:states>

	<mx:Script>
		<![CDATA[
			[Bindable]
			private var organismString:String;
			
			private function init():void {
				if (parentDocument != null && parentDocument.request != null
					&& parentDocument.request.hasOwnProperty("@idGenomeBuildAlignTo")
					&& parentDocument.request.@idGenomeBuildAlignTo != null
					&& parentDocument.request.@idGenomeBuildAlignTo != '') {
					alignCheckBox.selected = true;
					for each(var obj:Object in parentDocument.filteredGenomeBuildList) {
						if (obj.@idGenomeBuild == parentDocument.request.@idGenomeBuildAlignTo) {
							genomeBuildCombo.selectedItem = obj;
							break;
						}
					}
				} else {
					alignCheckBox.selected = false;
				}
				
				this.bioAssistCheckBox.selected = false;
				if (parentDocument != null && parentDocument.request != null
					&& parentDocument.request.hasOwnProperty("@bioinformaticsAssist")
					&& parentDocument.request.@bioinformaticsAssist == 'Y') {
					this.bioAssistCheckBox.selected = true;
				}
				
				organismString = 'Organism: ' + parentDocument.getOrganism() != null ? parentDocument.getOrganism().@organism : "N/A";
			}
			
			private function setAnalysisInstructions():void {
				parentDocument.request.@analysisInstructions = this.noteToBio.text;
			}

			public function propagateGenomeBuild():void {
				parentDocument.request.@idGenomeBuildAlignTo = alignCheckBox.selected ? genomeBuildCombo.selectedItem.@value : "";
				for each (var lane:Object in parentDocument.lanes) {
					if (this.genomeBuildCombo.selectedItem != null) {
						if(!alignCheckBox.selected) {
							lane.@idGenomeBuildAlignTo = "";
						} else {
							lane.@idGenomeBuildAlignTo = this.genomeBuildCombo.selectedItem.@value;						
						}					
					}
				}
				callLater(parentDocument.samplesView.checkSamplesCompleteness);
			}
			
			public function selectDefaultGenomeBuild():void {
				if (alignCheckBox.selected) {
					if (this.genomeBuildCombo.dataProvider.length > 1) {
						for each(var genomeBuild:Object in this.genomeBuildCombo.dataProvider) {
							if (genomeBuild.@isLatestBuild != null && genomeBuild.@isLatestBuild == 'Y') {
								this.genomeBuildCombo.selectedItem = genomeBuild;
								propagateGenomeBuild();
								break;
							}
						}
					}
				} else {
					genomeBuildCombo.selectedIndex = 0;
				}
			}
			
			private function onAlignCheckBoxClick():void {
				if (!alignCheckBox.selected) {
					genomeBuildCombo.selectedIndex = 0;
					genomeBuildCombo.enabled = false;
				} else {
					genomeBuildCombo.enabled = true;
					if (genomeBuildCombo.selectedIndex == 0) {
						this.selectDefaultGenomeBuild();
					}
				}
			}		
			
			private function onGenomeBuildComboChange():void {
				if (!alignCheckBox.selected) {
					genomeBuildCombo.selectedIndex = 0;	
				}
			}
			
			private function onBioAssistCheckBoxClick():void {
				if (bioAssistCheckBox.selected) {
					parentDocument.request.@bioinformaticsAssist = "Y";
				} else {
					parentDocument.request.@bioinformaticsAssist = "N";
				}
			}
		]]>
	</mx:Script>
	<mx:VBox id="bioNoteHBox" width="100%" verticalGap="0" >
		<mx:Spacer height="5" id="bioNoteSpacer" />
		<mx:Label text="(1) Would you like the Bionformatics Core Faciliy to perform analysis on this experiment."/>
		<mx:HBox width="100%" verticalGap="0" paddingBottom="0" paddingTop="0">
			<mx:Spacer width="12"/>
			<mx:CheckBox label="{'Yes   ' + parentApplication.getCoreFacilityProperty(parentDocument.getRequestCategory().@idCoreFacility, parentApplication.PROPERTY_REQUEST_BIO_ANALYSIS_NOTE)}"
						 id="bioAssistCheckBox" click="{onBioAssistCheckBoxClick()}" selected="false" />
		</mx:HBox>
		<mx:Spacer height="10" />
		<mx:VBox id="genomeBuildBox" width="100%" verticalGap="0">
			<mx:Label text="(2) Do you want the sequence data to be aligned?" width="314"  id="label11"/>
			<mx:HBox width="100%" verticalGap="0" paddingBottom="0" paddingTop="0">
				<mx:Spacer width="12"/>
				<mx:Label text="{organismString}"/>
			</mx:HBox>
			<mx:HBox width="100%" horizontalGap="2" verticalGap="0" paddingBottom="0" paddingTop="0">
				<mx:Spacer width="20"/>
				<mx:CheckBox id="alignCheckBox" label="Yes, align to genome build" click="{onAlignCheckBoxClick()}" selected="false"/>
				<mx:ComboBox labelField="@display" id="genomeBuildCombo" change="{onGenomeBuildComboChange()}" width="300" dataProvider="{parentDocument.filteredGenomeBuildList}" enabled="false">							
				</mx:ComboBox>                			
			</mx:HBox>
		</mx:VBox>
		<mx:Spacer height="10" />
		<mx:Label text="(3) Enter a note for the Bioinformatics Core Facility regarding analysis. (optional)" id="label3"/>
		<util:TextAreaWorkaround id="noteToBio" text="{parentDocument.request.@analysisInstructions}" 
								 focusOut="setAnalysisInstructions()" width ="100%" height="50%"/>
	</mx:VBox>
</mx:Canvas>
